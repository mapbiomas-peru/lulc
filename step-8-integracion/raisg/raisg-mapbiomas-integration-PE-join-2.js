/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var AMAZ_de_18_a_21 = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.4372862662393, -4.922922171679422],
                  [-79.43767250433744, -4.925573102344232],
                  [-79.42565620795072, -4.9253593180049675],
                  [-79.41891849890531, -4.918603697492509],
                  [-79.41466987982572, -4.914285195294578],
                  [-79.4146251651683, -4.913001575011243],
                  [-79.41466271609451, -4.912886663767398],
                  [-79.41470563143875, -4.912870629638775],
                  [-79.41478848719281, -4.912828591425453],
                  [-79.41531420015973, -4.912823246715491]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-79.40437019720854, -4.898806769555103],
                  [-79.39505756750883, -4.892136398170129],
                  [-79.39351261511625, -4.883541783211955],
                  [-79.39123810187162, -4.874818777786831],
                  [-79.39106644049467, -4.8722959266612405],
                  [-79.39063728705229, -4.865368727431322],
                  [-79.39364136114897, -4.863658296889934],
                  [-79.39784706488432, -4.879223054499423],
                  [-79.40531433478178, -4.897438493668596]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.95382957190509, -8.025297426126404],
                  [-75.34109763831134, -8.460209704546367],
                  [-75.69815330237384, -8.824072356258313],
                  [-75.70913963049884, -9.052940007478686],
                  [-75.58554343909259, -9.218356222730236],
                  [-74.85220603674884, -8.982411518551038],
                  [-74.45669822424884, -8.387810167044213],
                  [-74.41000632971759, -8.246490066927723],
                  [-74.78628806799884, -7.977299346464203]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-76.34115628581397, -5.793308296350178],
                  [-76.49220152191786, -5.903945569386592],
                  [-76.45651273112647, -6.112924959979643],
                  [-76.32742337565772, -6.355924896272029],
                  [-75.87698392253272, -6.514222921203063],
                  [-75.60232571940772, -6.489662676845422],
                  [-75.59683255534522, -6.246725380057222],
                  [-75.78085355143897, -6.006406790601261],
                  [-76.28622464518897, -5.760516699611222]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "3"
            })]),
    AMAZ_geometry6_21 = 
    /* color: #cb7a2f */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Point([-78.5931968621757, -7.175237213497832]),
            {
              "class_original": 6,
              "class_final": 21,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Point([-78.56195449157023, -7.193290463322028]),
            {
              "class_original": 6,
              "class_final": 21,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-75.49757945302566, -9.648842773226074],
                  [-75.43646800283035, -9.7178827361274],
                  [-75.31081187490066, -9.799764605446303],
                  [-75.24214732411941, -9.765254866822662],
                  [-75.24970042470535, -9.63868864200742],
                  [-75.35338389638504, -9.487292492922338],
                  [-75.51405894521316, -9.505577854783319]]]),
            {
              "class_original": 6,
              "class_final": 21,
              "system:index": "2"
            })]),
    AMAZ_geometry25_24 = 
    /* color: #942100 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.54294073975237, -8.355469940533986],
                  [-74.54259741699846, -8.368887013519968],
                  [-74.52371466553362, -8.378567399425998],
                  [-74.51736319458635, -8.369566346700017],
                  [-74.51564658081682, -8.355469940533986],
                  [-74.53092444336565, -8.359715899652327],
                  [-74.53909847736529, -8.352292397210931]]]),
            {
              "class_original": 25,
              "class_final": 24,
              "system:index": "0"
            })]),
    AMAZ_de_18_21 = 
    /* color: #98ff00 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-73.17263157495, -3.7362120803490733],
                  [-73.1667950881336, -3.7238786433436584],
                  [-73.1506589187, -3.6950999526588815],
                  [-73.13761265405157, -3.6759136397812173],
                  [-73.1283429396961, -3.6533006698522548],
                  [-73.13795597680547, -3.6080730239728513],
                  [-73.17503483422735, -3.6224638841101684],
                  [-73.21760685571172, -3.6495317860345917],
                  [-73.22550327905157, -3.6625514993525674],
                  [-73.21966679223516, -3.6817380999220513],
                  [-73.21520359643438, -3.699896466131796]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-73.03053730150212, -3.5025356044717935],
                  [-73.04736011644353, -3.5124733140082434],
                  [-73.08478229661931, -3.5559923780484253],
                  [-73.07139270921697, -3.5559923780484253],
                  [-73.05285328050603, -3.5532510800415977],
                  [-73.04324024339665, -3.547083129758299],
                  [-73.04186695238103, -3.530635061307216],
                  [-73.03191059251775, -3.5196695204027253],
                  [-73.02092426439275, -3.5042490102028565]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.72646453968916, -3.4898881107650195],
                  [-72.72234466664229, -3.504280815788677],
                  [-72.69350555531416, -3.4994832720025655],
                  [-72.70517852894697, -3.476180567640181]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.53557708851729, -3.5001686369054146],
                  [-72.54519012562666, -3.5316948787849456],
                  [-72.50948455922041, -3.5378629316210324],
                  [-72.47652557484541, -3.531009537049919],
                  [-72.46828582875166, -3.5118197634523454],
                  [-72.49300506703291, -3.4946857036501675]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-73.10414562984161, -3.57308032765452],
                  [-73.05539379878692, -3.5850731873348507],
                  [-72.99531231685333, -3.5634859270239287],
                  [-72.96441326900177, -3.526478018322083],
                  [-72.99325238032989, -3.5042040288303857],
                  [-73.00835858150177, -3.5011198961081607],
                  [-73.01797161861114, -3.500091849609844],
                  [-73.06157360835724, -3.5209952395199147]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.85592327876739, -3.485356392647472],
                  [-72.85180340572052, -3.4928954925494087],
                  [-72.82433758540802, -3.485356392647472],
                  [-72.83738385005645, -3.4737049376393037]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.09034005045048, -8.70852976453212],
                  [-74.04639473795048, -8.81575357898386],
                  [-73.95986814837366, -8.813727237185276],
                  [-73.86237374185673, -8.74110735608123],
                  [-73.74976387857548, -8.659658060087297],
                  [-73.88434639810673, -8.572759373998888],
                  [-73.98596993326298, -8.659658060087297]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-74.12329903482548, -8.527944461418542],
                  [-74.00107613443485, -8.723461513505415],
                  [-73.76075020670048, -8.616211213353889],
                  [-73.9324115836536, -8.41792198960872],
                  [-74.09445992349735, -8.48312429206958]]]),
            {
              "class_original": 18,
              "class_final": 21,
              "system:index": "7"
            })]),
    AMAZ_geometry21_18 = 
    /* color: #a456c3 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-73.24931055031705, -4.226566080442832],
                  [-73.25961023293424, -4.256010978933284],
                  [-73.24832637927389, -4.325350476892988],
                  [-73.20094783923483, -4.371907950557726],
                  [-73.12747676989889, -4.4177779269683555],
                  [-73.10893734118795, -4.374646535710617],
                  [-73.16249569079733, -4.350683576781837],
                  [-73.17073543689108, -4.266464871878422],
                  [-73.13640316150045, -4.254139404319956],
                  [-73.13159664294577, -4.192509119380393],
                  [-73.07735164782858, -4.162376984692034],
                  [-73.01486690661764, -4.165801149142959],
                  [-72.83806545830497, -4.282561990818646],
                  [-72.78346737048483, -4.296592958713298],
                  [-72.77522762439108, -4.2589326651716295],
                  [-72.78106497840363, -4.229136651119233],
                  [-72.95442391620496, -4.084283878982699],
                  [-72.99869264368617, -4.012812654084369],
                  [-73.02066529993617, -3.9271879297481864],
                  [-73.06323732142054, -3.84956659349423],
                  [-73.10031617884242, -3.8221623026920946],
                  [-73.16211427454554, -3.834494342295353],
                  [-73.15730775599086, -3.868749072666861],
                  [-73.14700800751672, -3.8916987301662322],
                  [-73.14529134460025, -3.9072838609940708],
                  [-73.15868104700648, -3.9153332811831243],
                  [-73.1593676925143, -3.9262938958494926],
                  [-73.15250123743617, -3.952324778196161],
                  [-73.16074098352992, -3.9701349114521687],
                  [-73.13945497278773, -4.036453727795614],
                  [-73.14426149134242, -4.065905709535433],
                  [-73.1600543380221, -4.099738721843545],
                  [-73.17447389368617, -4.172333582275872],
                  [-73.2197924972018, -4.199726131889922],
                  [-73.24136499797616, -4.2347795017412615]]]),
            {
              "class_original": 21,
              "class_final": 18,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-71.93325215598546, -3.633002901678541],
                  [-71.9799440505167, -3.8467799536020735],
                  [-71.82476216575108, -4.007077717047706],
                  [-71.5789430739542, -4.057763694309984],
                  [-71.39629536887608, -4.068722407682671],
                  [-71.30016499778233, -3.9563885985975666],
                  [-71.2878053786417, -3.891995251095098],
                  [-71.34960347434483, -3.85774145923767],
                  [-71.44298726340733, -3.8824043292796477],
                  [-71.51577168723546, -3.8604818135668886],
                  [-71.57619649192296, -3.8001919863302445],
                  [-71.62014180442296, -3.753601502721893],
                  [-71.68743306418858, -3.73304608557498],
                  [-71.74099141379796, -3.6987859890374755],
                  [-71.77395039817296, -3.6302618350304385],
                  [-71.83025532981358, -3.5864036414117955]]]),
            {
              "class_original": 21,
              "class_final": 18,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-73.21588089988444, -5.748962826841617],
                  [-73.39028885886881, -5.925198768114281],
                  [-73.31063797996256, -5.971639253273411],
                  [-73.18154862449381, -5.952517175658144],
                  [-73.15408280418131, -5.7503292090185365]]]),
            {
              "class_original": 21,
              "class_final": 18,
              "system:index": "2"
            })]),
    AMAZ_geometry24_25 = 
    /* color: #ffc82d */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.71543973573961, -12.853249788230785],
                  [-72.71432393678941, -12.857140879542326],
                  [-72.71149152406969, -12.857517433565498],
                  [-72.70973199495592, -12.856262251291673],
                  [-72.70921701082506, -12.8549233832824],
                  [-72.70943158754625, -12.852998748010954],
                  [-72.71204942354478, -12.851785383410537]]]),
            {
              "class_original": 24,
              "class_final": 25,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.69634143738243, -12.852109453844589],
                  [-72.69492523102257, -12.853866736336318],
                  [-72.69363777069542, -12.853113616774241],
                  [-72.69449607758018, -12.851481849974556]]]),
            {
              "class_original": 24,
              "class_final": 25,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.70474874027207, -12.868008221580645],
                  [-72.70461999423935, -12.868803133870896],
                  [-72.70251714237168, -12.86834292179941],
                  [-72.70028554447128, -12.86553979367411],
                  [-72.70062886722519, -12.864828547227177],
                  [-72.70281754978134, -12.866502065069032]]]),
            {
              "class_original": 24,
              "class_final": 25,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.70266734607651, -12.879178094150877],
                  [-72.704555621223, -12.879742875345896],
                  [-72.7034398222728, -12.882441256817561],
                  [-72.70195924289658, -12.882859607931879],
                  [-72.70125113971665, -12.881876481705046],
                  [-72.70146571643784, -12.88049591495907],
                  [-72.70219527728989, -12.88041224400269]]]),
            {
              "class_original": 24,
              "class_final": 25,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.69992733306168, -12.887765234542721],
                  [-72.69885444945572, -12.889375848261677],
                  [-72.69722366637467, -12.889564101137013],
                  [-72.69625807112931, -12.888873839902136],
                  [-72.69662285155533, -12.886970382396132],
                  [-72.69769573516129, -12.886259196758072],
                  [-72.69831800765274, -12.885610761033805],
                  [-72.69861841506241, -12.88563167834144],
                  [-72.69863987273453, -12.885171497169985],
                  [-72.69971275634049, -12.885715347554491],
                  [-72.7000560790944, -12.887095885534373]]]),
            {
              "class_original": 24,
              "class_final": 25,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[-72.7068911281897, -12.878789975778753],
                  [-72.70495993769897, -12.879354757848553],
                  [-72.70354373133911, -12.878413453691723],
                  [-72.70309312022461, -12.876468080563505],
                  [-72.70403725779785, -12.876447162490809],
                  [-72.70523888743652, -12.877179293995923],
                  [-72.70594699061645, -12.877158375982603],
                  [-72.70676238215698, -12.877576735917362]]]),
            {
              "class_original": 24,
              "class_final": 25,
              "system:index": "5"
            })]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/

// Integracion join 
var pais = 'PERU';
var id_pais = 8;
var inputAsset = 'projects/mapbiomas-raisg/COLECCION5/INTEGRACION/integracion-region';
var outputAsset = 'projects/mapbiomas-raisg/COLECCION5/INTEGRACION/integracion-pais';
var version_input = 1
var outputVersion = 2; 
var years = [2022, 2021]  // Lista de años Solo para visualizacion

// Asset o featurecollecion para remap
var assetsRemap = [
      // 'projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/AJUSTES3/ECUADOR',
      // 'projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/AJUSTES3/PERU',
      // 'projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/AJUSTES3/ECUADOR',
// 'projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/AJUSTES3/PERU',
// 'projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/AJUSTES3/ECUADOR',
// 'projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/AJUSTES3/PERU',
// 'projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/AJUSTES3/ECUADOR',
// 'projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/AJUSTES3/PERU',
AMAZ_de_18_a_21 , AMAZ_geometry6_21, AMAZ_geometry25_24,AMAZ_de_18_21,AMAZ_geometry21_18,AMAZ_de_18_21,AMAZ_geometry24_25
  ];
// import modules
var Legend = require('users/joaovsiqueira1/packages:Legend.js');

var palettes = require('users/mapbiomas/modules:Palettes.js');
var mapbiomasPalette = palettes.get('classification8');


/**
 * Export to asset
 */
var assetCountry = "projects/mapbiomas-raisg/DATOS_AUXILIARES/VECTORES/paises-5";
var paisraster = 'projects/mapbiomas-raisg/DATOS_AUXILIARES/RASTERS/paises-5';
var lim_raisg = 'projects/mapbiomas-raisg/DATOS_AUXILIARES/RASTERS/limite-raisg-5';
var regMosaic = 'projects/mapbiomas-raisg/DATOS_AUXILIARES/RASTERS/clasificacion-mosaicos-4'

// clasificacion coleccion 4 se usa para rellenar los pixeles 27 de la col4
var assetRaisgC4 = 'projects/mapbiomas-raisg/public/collection4/mapbiomas_raisg_panamazonia_collection4_integration_v1';
var raisgC4 = ee.Image(assetRaisgC4);
raisgC4 = raisgC4.addBands(
    raisgC4.select(['classification_2021'], ['classification_2022']));
    
var countries = ee.FeatureCollection(assetCountry);
var lim_raisg = ee.Image(lim_raisg);
print(countries)
var country = countries.filter(ee.Filter.eq('featureid', id_pais));
var countryMask = ee.Image(paisraster).eq(id_pais).selfMask();

var maskRaisg = lim_raisg.eq(1).and(countryMask.eq(1)).selfMask()

Map.addLayer(country,{},'COUNTRY')
Map.addLayer(lim_raisg,{},'lim_raisg')

var integrated = ee.Image()//.select()
// print(integrated)

// Integrate
// assetList.forEach(function(id){
//   var imageIntegrate = ee.Image(inputAsset+id);
//   integrated = integrated.blend(imageIntegrate)
  
// })
var integrated = ee.ImageCollection(inputAsset).filter(ee.Filter.eq('pais', pais))
                                               .filter(ee.Filter.eq('version', version_input))
                                               .mosaic()
print(integrated)
// Map.addLayer(country.geometry().bounds(),{},'country')
integrated = integrated.unmask(27)
                      // .mask(countryMask)
                      .mask(maskRaisg);

// REMAP------------------------------------------------------------------------------------

  // load remap polygons
  var remapCollection = ee.FeatureCollection(
      assetsRemap.map(
          function (item) {
              return ee.FeatureCollection(item);
          }
      )
  ).flatten();
  
  // Get remap masks
  var integratedRemaped = remapCollection.iterate(
      function (feature, image) {
          image = ee.Image(image);
  
          var polygon = ee.FeatureCollection(feature);
          var original = ee.Image().paint(polygon, 'class_original')
              .clipToBoundsAndScale(polygon.geometry(), null, null, null, 30);
  
          var final = ee.Image().paint(polygon, 'class_final')
              .clipToBoundsAndScale(polygon.geometry(), null, null, null, 30);
  
          return image.where(image.eq(original), final);
      },
      integrated
  );
  
  
  integratedRemaped = ee.Image(integratedRemaped);
  integratedRemaped = integratedRemaped
                            .where(integratedRemaped.eq(27), 0)
                            .selfMask()
                            .unmask(raisgC4)
                            // .mask(countryMask)
                            .mask(maskRaisg);
//------------------------------------------------------------------------------------





// Map.addLayer(integrated,{
//                 'bands': 'classification_2021',
//                 'min': 0,
//                 'max': 62,
//                 'palette': mapbiomasPalette,
//                 'format': 'png'
//             }, 'integrated')


// Map.addLayer(integratedRemaped,{
//                 'bands': 'classification_2021',
//                 'min': 0,
//                 'max': 62,
//                 'palette': mapbiomasPalette,
//                 'format': 'png'
//             }, 'integratedRemaped')




Export.image.toAsset({
  'image': integratedRemaped.byte(),
  'description': pais + '-' + outputVersion,
  'assetId': outputAsset + '/' + pais + '-' + outputVersion,
  'pyramidingPolicy': {
      ".default": "mode"
  },
  'region': country.geometry().bounds(),
  'scale': 30,
  'maxPixels': 1e13
});




var regionesMosaicRaster = 'projects/mapbiomas-raisg/DATOS_AUXILIARES/RASTERS/clasificacion-mosaicos-4'
var assetMosaic = "projects/nexgenmap/MapBiomas2/LANDSAT/PANAMAZON/mosaics-2";
var assetMosaicP2 = "projects/nexgenmap/MapBiomas2/LANDSAT/PANAMAZON/mosaics-pathrow-2";
var regionMosaicRaster  = ee.Image(regionesMosaicRaster).rename(['regions'])



/**
  * Get mosaics
  * Get mosaics from collection2 asset col4 mapbiomas Amaz. Then compute
  * wetlands indexes remaining.
  */
var getMosaic = function(paths, regionRaster, Listyears) {
  
      // Mosaic
      regionRaster = regionRaster.where(regionRaster.eq(211),210)
      regionRaster = regionRaster.where(regionRaster.eq(205),210)
      var Mosaic_coll = ee.ImageCollection(paths[0]).merge(ee.ImageCollection(paths[1]))
                                                    .filter(ee.Filter.inList('year',Listyears))
                        // .filterMetadata('country', 'equals', param.pais)
                        // .select(['swir1_median', 'nir_median', 'red_median'])
                        .map(
                            function (image) {
                                return image.updateMask(
                                    regionRaster.eq(ee.Number.parse(image.get('region_code')).toInt16()));
                            }
                        );
                        
                          

      // Aditional Bands
      var joinedMosaics = Mosaic_coll;
                  
      
      // Select variables
      return joinedMosaics;
      
  };

var mosaicsRAISG = getMosaic([assetMosaic,assetMosaicP2], regionMosaicRaster, years);

for (var yearI=0;yearI<years.length;yearI++) {
  var vis = {
      'bands': 'classification_'+years[yearI],
           'min': 0,
           'max': 62,
           'palette': mapbiomasPalette,
  };
  
  var mosaicYear = mosaicsRAISG
                    .filterMetadata('year', 'equals', years[yearI])
                    .mosaic();
  
  Map.addLayer(mosaicYear,{
          "bands":["swir1_median","nir_median","red_median"],
          // "min":407,"max":3381,
          'gain': [0.08, 0.06, 0.08],
          'gamma': 0.65
  }, 'Mosaic' + years[yearI],false);
  
  Map.addLayer(integrated, vis, 'classification_'+years[yearI],false);

  Map.addLayer(integratedRemaped, vis, 'classification_remap_'+years[yearI],false);

}
